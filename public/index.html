<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>See my real-time location on Google Maps! | Visit Google Maps to check out my real-time location. With the Google Maps App you can share your location with friends and family too.</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="shortcut icon" href="#" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body,
        html {
            height: 100%;
            overflow: hidden;
            /* Prevent scrolling */
        }

        #map {
            height: 100vh;
            /* Full viewport height */
            width: 100vw;
            /* Full viewport width */
        }

           /* Google Maps Logo Styling with Transparent Background */
        .google-logo {
    position: absolute;
    bottom: 10px;
    left: 10px;
    z-index: 1000;
    padding: 5px;
    opacity: 0.8; /* Make the logo slightly transparent */
}

.google-logo img {
    max-width: 80px; /* Adjust the size to be responsive */
    height: auto;    /* Maintain aspect ratio */
}

        .user-marker {
            border-radius: 50%;
            /* Makes the icon circular */
            overflow: hidden;
            width: 50px;
            height: 50px;
            border-color: red;
        }

        /* Optional fullscreen button */
        
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
</head>

<body>
    <div id="map"></div>
    <!-- Google Maps Logo Overlay with transparent background -->
    <div class="google-logo">
        <img src="google_maps_logo.png" alt="Google Maps Logo" width="100px">
    </div>
    <script>
      const socket = io();

        // Initialize the map
        const map = L.map('map').setView([0, 0], 13); // Start with a view at latitude 0, longitude 0
    
        const marker = L.marker([0, 0]).addTo(map);


          
        // Define tile layers

        // Define Google Maps layers
            const googleStreetLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                maxZoom: 16,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                attribution: '&copy; <a href="https://www.google.com/intl/en_us/help/terms_maps.html">Google</a> - Street View'
            });

            const googleHybridLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=y,h&x={x}&y={y}&z={z}', {
                    maxZoom: 18,
                    subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                    attribution: '&copy; <a href="https://www.google.com/intl/en_us/help/terms_maps.html">Google</a> - Hybrid (Satellite + Labels)'
                });


                const googleTerrainLayer = L.tileLayer('https://{s}.google.com/vt?lyrs=p&x={x}&y={y}&z={z}', {
                        maxZoom: 16,
                        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                        attribution: '&copy; <a href="https://www.google.com/intl/en_us/help/terms_maps.html">Google</a> - Terrain'
                    });

                    const googleTrafficLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=m,h&x={x}&y={y}&z={z}', {
                        maxZoom: 15,
                        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                        attribution: '&copy; <a href="https://www.google.com/intl/en_us/help/terms_maps.html">Google</a> - Traffic'
                    });


    const baseLayers = {
        "Map View": googleStreetLayer,
        "Satellite View": googleHybridLayer,
        "Terrain View": googleTerrainLayer,
        "Show Traffic": googleTrafficLayer
    };

     // Create a marker variable to store the user's marker
     googleStreetLayer.addTo(map);
    L.control.layers(baseLayers).addTo(map);
        // Create a marker
      


            // Trigger to get current position
        socket.on('locationUpdate', (data) => {
            const { latitude, longitude } = data;
            //  console.log('Location update received in frontend:', data); // Log the received data
            // if (lat && lng) {
            // Log before updating
            //console.log('Updating marker and centering map...');
            // console.log(data.latitude);

            // Convert base64 image back to image source
            const imgSrc = `data:image/png;base64,${data.userimage}`;

            // Add a marker with a custom icon (user's image) and popup (username)
            const icon = L.icon({
                iconUrl: imgSrc,
                iconSize: [50, 50],
                className: 'user-marker'
            });
            // Update marker position and map view
            // marker.setLatLng([data.latitude, data.longitude]);
            map.setView([data.latitude, data.longitude], 13);
            L.marker([data.latitude, data.longitude], { icon: icon })
                .addTo(map)
                .bindPopup(`<b>${data.username}</b>`);
            // } else {
            //     console.error('Invalid coordinates received');
            // }
            //  Function to get current GPS position
            function getCurrentPosition() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        map.setView([lat, lng], 13); // Center the map at the current position
                        L.marker([lat, lng]).addTo(map).bindPopup('You are here!').openPopup();
                    }, (error) => {
                        console.error('Error obtaining location:', error);
                    });
                } else {
                    console.error("Geolocation is not supported by this browser.");
                }
            }
            getCurrentPosition();

            // Optional: Draw a route from current position to the sender's location
            const currentLatLng = map.getCenter();
            L.Routing.control({
                waypoints: [
                    L.latLng(currentLatLng.lat, currentLatLng.lng),
                    L.latLng(data.latitude, data.longitude)
                ],
                routeWhileDragging: true
            }).addTo(map);


        });

        // Fullscreen logic
            function requestFullscreen() {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.mozRequestFullScreen) { // Firefox
                    document.documentElement.mozRequestFullScreen();
                } else if (document.documentElement.webkitRequestFullscreen) { // Chrome, Safari, and Opera
                    document.documentElement.webkitRequestFullscreen();
                } else if (document.documentElement.msRequestFullscreen) { // IE/Edge
                    document.documentElement.msRequestFullscreen();
                }
            }

        // Trigger fullscreen on first touch
            window.addEventListener('touchstart', () => {
                requestFullscreen();
            }, { once: false }); // Ensures fullscreen is only requested once

    window.addEventListener('click', () => {
        requestFullscreen();
    }, { once: false }); // Ensures fullscreen is only requested once



        // Check connection
        socket.on('connect', () => {
            console.log('Connected to the server');
        });
    </script>
</body>

</html>